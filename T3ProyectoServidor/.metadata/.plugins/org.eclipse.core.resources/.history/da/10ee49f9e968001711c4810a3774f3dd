package frm;

import java.awt.EventQueue;
import java.io.BufferedWriter;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStreamWriter;
import java.net.ServerSocket;
import java.net.Socket;

import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;

import org.joda.time.DateTime;

import entidades.entMaeCli;
import negocio.negCliente;

import javax.swing.JScrollPane;
import javax.swing.JTextArea;

public class frmServidor extends JFrame implements Runnable{
	
	static ServerSocket servidor = null;
	
	
	static entMaeCli mc=null;
	Thread hilo;
	/**
	 * 
	 */
	private static final long serialVersionUID = -4787352196010705642L;
	boolean banderaV = true;
	boolean banderaM = false;
	private JPanel contentPane;
	private JTextArea txtContenedor;

	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					frmServidor frame = new frmServidor();
					frame.setVisible(true);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}

	public frmServidor() {
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		setBounds(100, 100, 450, 334);
		contentPane = new JPanel();
		contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
		setContentPane(contentPane);
		contentPane.setLayout(null);
		
		JScrollPane scrollPane = new JScrollPane();
		scrollPane.setBounds(10, 11, 414, 239);
		contentPane.add(scrollPane);
		
		txtContenedor = new JTextArea();
		scrollPane.setViewportView(txtContenedor);
		hilo = new Thread(this);
		hilo.start();
	}

	@Override
	public void run() {
		try {
			servidor = new ServerSocket(5003);
			while (banderaV) {
				
				try {
					Socket cli = null;
					ObjectOutputStream datoflujo,datoflujo2;
					ObjectInputStream flujo;
					
					cli = servidor.accept();
					flujo = new ObjectInputStream(cli.getInputStream());
					mc = (entMaeCli) flujo.readObject();
					System.out.println("entMaeCli mc: "+mc);	
				
					txtContenedor.append("\n"+"=========================");	
					txtContenedor.append("\n"+mc.getNumeroTarjeta());
					txtContenedor.append("\n"+mc.getClave());
					txtContenedor.append("\n"+"=========================");
					
										
					entMaeCli mlv = negCliente.Instancia().verificarAccesoCliente(mc.getNumeroTarjeta(),mc.getClave());
					System.out.println("mlv: "+mlv);			
					
					if(!mlv.equals("")){

						datoflujo = new ObjectOutputStream(cli.getOutputStream());
						datoflujo.writeObject(mlv);
						

						System.out.println(mlv);
						
						txtContenedor.append("\n"+"=========================");	
						txtContenedor.append("\n"+"Saldo : "+mlv.getSaldo());
						txtContenedor.append("\n"+"=========================");
						banderaV = false;
						banderaM = true;
						flujo.close();
						datoflujo.close();
						cli.close();
						hilo.resume();
						return;
					}
					System.out.println(mlv);
					datoflujo = new ObjectOutputStream(cli.getOutputStream());
					datoflujo.writeObject(new entMaeCli());							
					flujo.close();
					datoflujo.close();
					cli.close();
					hilo.resume();
				}
				catch (Exception e) {
					System.out.println("Error en  VerificarAcceso : "+e.getMessage());
				}
			}
			while(banderaM){

				try {
					hilo.start();
					Socket cli = null;
					ObjectOutputStream datoflujo,datoflujo2;
					ObjectInputStream flujo;
					
					cli = servidor.accept();
					flujo = new ObjectInputStream(cli.getInputStream());
					entMaeCli mc = (entMaeCli) flujo.readObject();
					System.out.println(mc.toString());
					
					
					entMaeCli entNuevo = new entMaeCli();
	
					entNuevo.setUltMovMonto(mc.getUltMovMonto());
					System.out.println(mc.getUltMovMonto());
					entNuevo.setFechaUlt(mc.getFechaUlt());
					System.out.println(mc.getFechaUlt());
					entNuevo.setHoraUlt(mc.getHoraUlt());
					System.out.println(mc.getHoraUlt());
					entNuevo.setId(mlv.getId());
					System.out.println(mlv.getId());
					entNuevo.setNombre(mlv.getNombre());
					System.out.println(mlv.getNombre());
					entNuevo.setNumeroTarjeta(mlv.getNumeroTarjeta());
					System.out.println(mlv.getNumeroTarjeta());
					entNuevo.setSaldo(mlv.getSaldo()-mc.getUltMovMonto());
					System.out.println(mlv.getSaldo()-mc.getUltMovMonto());
					
					
					System.out.println(entNuevo.toString());
					
					try {
						
						boolean x = negCliente.Instancia().editarMaeCliente(entNuevo);
						if(x){
						File archivo = new File("c:\\log\\data_atm.log");
						BufferedWriter Fescribe = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(archivo,true),"utf-8"));
						Fescribe.write(entNuevo+"\r\n");
						Fescribe.close();	
						}
					} catch (Exception e) {					
						hilo.resume();
						System.out.println("Error al grabar en el log : "+e.getMessage());
					}
					
					datoflujo2 = new ObjectOutputStream(cli.getOutputStream());
					datoflujo2.writeObject(entNuevo);
					datoflujo2.close();
					flujo.close();
					cli.close();
				} catch (Exception e) {
					// TODO: handle exception
				}
			}
			
		} catch (Exception e) {
			   System.out.println("Error Run: "+e.getMessage());
		}
	}
}
